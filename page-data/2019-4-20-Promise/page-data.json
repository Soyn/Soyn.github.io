{"componentChunkName":"component---src-templates-blog-post-js","path":"/2019-4-20-Promise/","result":{"data":{"site":{"siteMetadata":{"title":"Move fast and break things.","author":"wang yao","siteUrl":"http://cuteshilina.com","comment":{"disqusShortName":"","utterances":"Soyn/Soyn.github.io.git"},"sponsor":{"buyMeACoffeeId":"jbee"}}},"markdownRemark":{"id":"573bb285-2551-5253-9836-8f103ca7adc3","excerpt":"什么是Promise？ 英文翻译过来是诺言、承诺的意思  顾名思义，的潜在含义是： 代表的是还没发生的事 在事情没有完成之前，无法确定是成功还是失败 而在中的代表的意义是类似的，对于异步操作（网络请求、文件I/O等）这些事情在完成之前无法确定其状态，在完成的时候要么成功要么失败，会在完成的时候通知你。  上面是的定义，是一个表示异步事件处理完成的对象，我们看看传统的异步操作是怎样的： 在传统的异步操作下，整个接口的定义实现方式，没有一个清晰的定义，不同的人去写，接口的定义方式不一样。 在中，抽象出了异步操作成功（then）的接口和失败的接口（catch…","html":"<h1 id=\"什么是promise？\" style=\"position:relative;\"><a href=\"#%E4%BB%80%E4%B9%88%E6%98%AFpromise%EF%BC%9F\" aria-label=\"什么是promise？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>什么是Promise？</h1>\n<p><code class=\"language-text\">Promise</code>英文翻译过来是诺言、承诺的意思</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA6ElEQVQoz32R246DMAxE8/9f2SdgWylXQu64Hm9D2Ze1dISj2OOJUSZk+jGFnsyRMpXMlCLUWj8gb5RLv+7+3n9RKSWyxpD2XFQ7tVaZTmOMi5PRxtNjcbTHROgBd3FwHAcpqDrnWaTRf6G1ptfrKU0xRmHfd2GeQwikeu+U+Zl3R3cwGcNQDCAw84lzTgZ67+GwSRGEZ5zneTGF4QyNc8CXLrubO1XYm7FeijEN1uE4gc+eEGHPLJpo9N/9wsAURT54eMosKMUstCwLbdt2WYdrCAPEuq5kreVa7C2KY4jhhfJt/ONCpzcdcSH/CANqFwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"promise 0\"\n        title=\"promise 0\"\n        src=\"/static/95463ff1299e26085f3987868aa50483/fcda8/promise_0.png\"\n        srcset=\"/static/95463ff1299e26085f3987868aa50483/12f09/promise_0.png 148w,\n/static/95463ff1299e26085f3987868aa50483/e4a3f/promise_0.png 295w,\n/static/95463ff1299e26085f3987868aa50483/fcda8/promise_0.png 590w,\n/static/95463ff1299e26085f3987868aa50483/efc66/promise_0.png 885w,\n/static/95463ff1299e26085f3987868aa50483/c83ae/promise_0.png 1180w,\n/static/95463ff1299e26085f3987868aa50483/4cdc7/promise_0.png 1327w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>顾名思义，<code class=\"language-text\">Promise</code>的潜在含义是：</p>\n<ul>\n<li><code class=\"language-text\">promise</code>代表的是还没发生的事</li>\n<li>在事情没有完成之前，无法确定是成功还是失败</li>\n</ul>\n<p>而在<code class=\"language-text\">Javascript</code>中的<code class=\"language-text\">Promise</code>代表的意义是类似的，对于异步操作（网络请求、文件I/O等）这些事情在完成之前无法确定其状态，在完成的时候要么成功要么失败，<code class=\"language-text\">Promise</code>会在完成的时候通知你。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.972972972972975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAuklEQVQY011Pyw7DIAzr///hxPpCrLSU0gI7tL14czQ4DMlySJzEaVJ+wzgP6wOO44BzDuu6YlkWAf/e+8rzPAuX3L7vwsyzr2HTQz2hzQvDMAi6rkPbtjXu+15ipVStjeMorLWWujEGIQQ0KaXvloAUI7ZtE5cEi2Q6KDGZzhjnnKXG/3meKE8G0i6LRRC/w9lM8IwyLP6WUsfLyjJq2MecnEzr1lpM0ySnUXTft2wmruuqKP//PPXkD3nNeIS908obAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"promise 1\"\n        title=\"promise 1\"\n        src=\"/static/c2e993dbc1bbc9041d6b35e9840070d5/fcda8/promise_1.png\"\n        srcset=\"/static/c2e993dbc1bbc9041d6b35e9840070d5/12f09/promise_1.png 148w,\n/static/c2e993dbc1bbc9041d6b35e9840070d5/e4a3f/promise_1.png 295w,\n/static/c2e993dbc1bbc9041d6b35e9840070d5/fcda8/promise_1.png 590w,\n/static/c2e993dbc1bbc9041d6b35e9840070d5/d0c0e/promise_1.png 715w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>上面是<code class=\"language-text\">Promise</code>的定义，<code class=\"language-text\">Promise</code>是一个表示异步事件处理完成的对象，我们看看传统的异步操作是怎样的：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token keyword\">function</span> <span class=\"token function\">successCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Result is ready: '</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">function</span> <span class=\"token function\">failureCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error on async request: '</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">requestData</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">,</span> sucessCallback<span class=\"token punctuation\">,</span> failureCallback<span class=\"token punctuation\">)</span></code></pre></div>\n<p>在传统的异步操作下，整个接口的定义实现方式，没有一个清晰的定义，不同的人去写，接口的定义方式不一样。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token keyword\">function</span> <span class=\"token function\">successCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Result is ready: '</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">function</span> <span class=\"token function\">failureCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error on async request: '</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">requestData</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>successCallback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>failureCallback<span class=\"token punctuation\">)</span></code></pre></div>\n<p>在<code class=\"language-text\">Promise</code>中，抽象出了异步操作成功（then）的接口和失败的接口（catch/reject），并且支持链式调用，在传统的<code class=\"language-text\">callback</code>的实现中，如果下一个异步操作依赖于上一个操作，很容易写出<code class=\"language-text\">callback hell</code>的这种代码，对于代码的阅读和维护带来麻烦。</p>\n<h1 id=\"promise的状态\" style=\"position:relative;\"><a href=\"#promise%E7%9A%84%E7%8A%B6%E6%80%81\" aria-label=\"promise的状态 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Promise的状态</h1>\n<p><code class=\"language-text\">Promise</code>对象对象是一个代理对象，被代理的值表示一个异步操作，在创建的时候，对于最终异步操作的返回结果是未知的，<code class=\"language-text\">Promise</code>允许为异步操作的成功和失败分别绑定相应的处理方法，让异步方法可以像同步方法一样返回值，但并不是立即返回最终的执行结果，而是一个代理了未来出现的结果的<code class=\"language-text\">Promise</code>对象，<code class=\"language-text\">Promise</code>有以下几种状态：</p>\n<ul>\n<li><code class=\"language-text\">pending:</code>初始状态，创建<code class=\"language-text\">promise</code>之后，执行还没结束的时候</li>\n<li><code class=\"language-text\">fulfilled：</code>异步操作成功</li>\n<li><code class=\"language-text\">rejected:</code>异步操作失败</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.54054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAyklEQVQoz4VSiwqEIBD0/3/yiuCqi9LKXvSYc4S1Q6QbWMp1d5xZVdd1geA3Dskvy4JxHLGua7R/1wmUNKWw7zuO40Df92iaBtZaPAlgKCk4zzMkSTTPM6qqRF3XXt22baFO/lNQoqQs3+g6HewNw4C2bfFxykhOdVSqtXYHVd4+Q+p4iFdIQi5YbKcJkwtjjF/neY4se3kykpKA+zJPhowjEKbmxxwJqIaW2cQG2v0HlRpwDFoqisITP11IsPyrLG6gKgne+NOrIL52rnQE5axeCgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"promise 2\"\n        title=\"promise 2\"\n        src=\"/static/cf8c26f621956c651b9653d450816898/fcda8/promise_2.png\"\n        srcset=\"/static/cf8c26f621956c651b9653d450816898/12f09/promise_2.png 148w,\n/static/cf8c26f621956c651b9653d450816898/e4a3f/promise_2.png 295w,\n/static/cf8c26f621956c651b9653d450816898/fcda8/promise_2.png 590w,\n/static/cf8c26f621956c651b9653d450816898/0f2bc/promise_2.png 742w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>如上图，在<code class=\"language-text\">promise</code>创建后，所处的状态为<code class=\"language-text\">pending</code>状态，执行成功或失败的这个过程叫<code class=\"language-text\">settled</code>，<code class=\"language-text\">settled</code>之后，<code class=\"language-text\">promise</code>由<code class=\"language-text\">pending</code>状态转换到<code class=\"language-text\">fulfilled</code>或<code class=\"language-text\">rejected</code>状态，并执行相应的回调。</p>\n<h1 id=\"how-to-use-promise\" style=\"position:relative;\"><a href=\"#how-to-use-promise\" aria-label=\"how to use promise permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to use Promise?</h1>\n<p>我们首先来看看<code class=\"language-text\">Promise</code>提供的方法：</p>\n<h2 id=\"constructor\" style=\"position:relative;\"><a href=\"#constructor\" aria-label=\"constructor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Constructor</h2>\n<p>常见的方式是通过<code class=\"language-text\">Promise</code>的构造函数得到Promise的实例：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token keyword\">function</span> <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> r <span class=\"token operator\">=</span> <span class=\"token function\">asyncWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        r<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'success'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">s</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        r<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n     <span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> <span class=\"token function\">Promise</span><span class=\"token punctuation\">(</span>executor<span class=\"token punctuation\">)</span></code></pre></div>\n<p>如上<code class=\"language-text\">Promise</code>的构造函数接收一个<code class=\"language-text\">executor</code>函数为参数，这个<code class=\"language-text\">executor</code>一般来说是一个异步操作，在生成实例的时候会被执行，在执行成功的时候调用<code class=\"language-text\">resolve</code>，失败的时候调用<code class=\"language-text\">reject</code>。</p>\n<h2 id=\"实例方法\" style=\"position:relative;\"><a href=\"#%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95\" aria-label=\"实例方法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>实例方法</h2>\n<ul>\n<li><code class=\"language-text\">Promise.prototype.then(onFulfilled?, onRejected?)</code>，在<code class=\"language-text\">promise resolve</code>的时候<code class=\"language-text\">onFulfilled</code>会被调用，<code class=\"language-text\">reject</code>的时候<code class=\"language-text\">onReject</code>会被调用，这两个参数是可选的，如果你只想对异常进行处理的话，可以使用<code class=\"language-text\">promise.then(undefined, onRejected)</code></li>\n<li><code class=\"language-text\">Promise.prototype.catch(onRejected)</code>，<code class=\"language-text\">catch</code>方法会在<code class=\"language-text\">promise reject</code>的时候被调用。</li>\n<li><code class=\"language-text\">Promise.prototype.finally(onFinally)</code>，向当前<code class=\"language-text\">promise</code>添加一个回调函数，无论当前<code class=\"language-text\">promise</code>的状态是完成还是失败都会被调用</li>\n</ul>\n<h2 id=\"静态方法\" style=\"position:relative;\"><a href=\"#%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95\" aria-label=\"静态方法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>静态方法</h2>\n<ul>\n<li><code class=\"language-text\">Promise.resolve(value)</code>，返回一个由给定<code class=\"language-text\">value</code>决定的<code class=\"language-text\">promise</code>对象；如果这个<code class=\"language-text\">value</code>可以是一个<code class=\"language-text\">thenable</code>的对象（带有<code class=\"language-text\">then</code>方法的对象），最终返回的<code class=\"language-text\">promise</code>对象的状态由<code class=\"language-text\">then</code>方法执行决定；否则的话，返回的<code class=\"language-text\">promise</code>对象状态为<code class=\"language-text\">fulfilled</code>，并且将该值传给对应的<code class=\"language-text\">then</code>方法，如果你不知道一个值是否是<code class=\"language-text\">Promise</code>对象，使用<code class=\"language-text\">Promise.resolve(value)</code>来返回一个<code class=\"language-text\">Promise</code>对象，这样就能将该<code class=\"language-text\">value</code>以<code class=\"language-text\">Promise</code>对象的形式使用。</li>\n<li><code class=\"language-text\">Promise.reject(reason)</code>，返回一个执行状态为<code class=\"language-text\">rejected</code>的<code class=\"language-text\">Promise</code>对象，并将错误信息给到对应的处理函数</li>\n<li><code class=\"language-text\">Promise.race(iterable)</code>，当<code class=\"language-text\">iterable</code>中的任意一个子<code class=\"language-text\">promise</code>成功或者失败后，父<code class=\"language-text\">promise</code>会使用这个子<code class=\"language-text\">promise</code>的结果，传给父<code class=\"language-text\">promise</code>绑定的回调上</li>\n<li><code class=\"language-text\">Promise.all(iterable)</code>，这个方法返回一个<code class=\"language-text\">promise</code>对象，只有<code class=\"language-text\">iterable</code>中所有的<code class=\"language-text\">promise</code>执行成功的时候才会触发成功，一旦由任何一个执行失败都会触发要返回这个<code class=\"language-text\">promise</code>额失败，最终<code class=\"language-text\">iterable</code>的返回结果和<code class=\"language-text\">iterable</code>的顺序一致。</li>\n</ul>\n<p><code class=\"language-text\">promise</code>是支持链式调用的：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token function-variable function\">then</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">finally</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"promise的错误处理\" style=\"position:relative;\"><a href=\"#promise%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86\" aria-label=\"promise的错误处理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Promise的错误处理</h2>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token comment\">// use `catch`</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Init'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// {A}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// {B}</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'123'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error was caught!'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'End'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\">// use reject</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Init'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'End'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error was caught!'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">promise</code>在处理错误的时候，可以通过<code class=\"language-text\">Promise.ptototype.catch</code>或者是注册的<code class=\"language-text\">reject</code>方法来处理错误，在<code class=\"language-text\">{A}</code>行处，抛出了错误，这里<code class=\"language-text\">promise</code>的状态会变为<code class=\"language-text\">rejected</code>，会调用对应的回调函数，在<code class=\"language-text\">{A}</code>到<code class=\"language-text\">.catch</code>之间的<code class=\"language-text\">promise</code>链会被打断。</p>\n<h1 id=\"wraaper-by-promise\" style=\"position:relative;\"><a href=\"#wraaper-by-promise\" aria-label=\"wraaper by promise permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wraaper by Promise</h1>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token keyword\">function</span> <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ms</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> ms<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>我们在使用<code class=\"language-text\">setTimeout</code>的时候，<code class=\"language-text\">setTimeout</code>执行的函数如果执行发生了错误，并且在函数的实现中并没有做<code class=\"language-text\">Error Handling</code>，函数执行发生错误的时机我们并不知道，如果使用上面基于<code class=\"language-text\">promise</code>包裹之后的<code class=\"language-text\">timeout</code>，我们是可以明确知道错误发生的时机的。</p>\n<h2 id=\"超时promise\" style=\"position:relative;\"><a href=\"#%E8%B6%85%E6%97%B6promise\" aria-label=\"超时promise permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>超时Promise</h2>\n<p><code class=\"language-text\">promise</code>创建之后，会等待异步操作的执行，如果异步操作的时间很长的话，这个<code class=\"language-text\">promise</code>一直处于  <code class=\"language-text\">pending</code>状态，对于用户来说，页面会一直停留在<code class=\"language-text\">loading</code>的状态，显然，用户体验并不好，因此，对于这种情况，我们需要提供可以在超时之后，取消<code class=\"language-text\">promsie</code>的机制：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token keyword\">function</span> <span class=\"token function\">delayPromise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ms</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span>ms<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Operation is timeout!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">function</span> timeoutPromise <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>asyncFn<span class=\"token punctuation\">,</span> ms<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">race</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span>asyncFn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token function\">delayPromise</span><span class=\"token punctuation\">(</span>ms<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>如上我们基于<code class=\"language-text\">Promise.race</code>实现了超时<code class=\"language-text\">promise</code>。</p>\n<h2 id=\"refrence\" style=\"position:relative;\"><a href=\"#refrence\" aria-label=\"refrence permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Refrence</h2>\n<ul>\n<li><a href=\"http://liubin.org/promises-book/\">Promise迷你书</a></li>\n<li><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise\">Promise</a></li>\n</ul>\n<hr>\n<p><strong><em>兴趣遍地都是，坚持和持之以恒才是稀缺的</em></strong></p>","frontmatter":{"title":"Promise初探","date":"April 20, 2019"}}},"pageContext":{"slug":"/2019-4-20-Promise/","previous":{"fields":{"slug":"/2019-4-13-frontend-route/"},"frontmatter":{"title":"前端路由","category":"Tech"}},"next":{"fields":{"slug":"/2019-5-11-sameOriginPolicy/"},"frontmatter":{"title":"浏览器同源策略","category":"Tech"}}}},"staticQueryHashes":["3128451518","96099027"]}