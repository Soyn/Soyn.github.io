{"componentChunkName":"component---src-templates-blog-post-js","path":"/2018-12-22-TreeShaking/","result":{"data":{"site":{"siteMetadata":{"title":"Move fast and break things.","author":"wang yao","siteUrl":"http://cuteshilina.com","comment":{"disqusShortName":"","utterances":"Soyn/Soyn.github.io.git"},"sponsor":{"buyMeACoffeeId":"jbee"}}},"markdownRemark":{"id":"1603dad0-daf7-5b01-b867-3f3dd035b4be","excerpt":"TL;DR; 前端打包中会将多个module打包成一个bundle发给客户端，但是各个module中存在并不会使用到的东西，dead code elimination是一种可以消除这些代码的技术 Tree Shaking是Dead code elimination（简称DCE）的一种实现 Webpack中的tree shaking需要es6的的支持 Webpack中的tree shaking仅仅能作用与顶层函数、顶层变量、顶层对象，如果定义一个函数集合的Object，如果仅仅只使用了一部分函数，其他的函数仍然会被打进去 什么是Tree Shaking…","html":"<h2 id=\"tldr\" style=\"position:relative;\"><a href=\"#tldr\" aria-label=\"tldr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TL;DR;</h2>\n<ul>\n<li>前端打包中会将多个module打包成一个bundle发给客户端，但是各个module中存在并不会使用到的东西，dead code elimination是一种可以消除这些代码的技术</li>\n<li>Tree Shaking是Dead code elimination（简称DCE）的一种实现</li>\n<li>Webpack中的tree shaking需要es6的<code class=\"language-text\">import/export</code>的支持</li>\n<li>\n<p>Webpack中的tree shaking仅仅能作用与顶层函数、顶层变量、顶层对象，如果定义一个函数集合的Object，如果仅仅只使用了一部分函数，其他的函数仍然会被打进去</p>\n<h2 id=\"什么是tree-shaking\" style=\"position:relative;\"><a href=\"#%E4%BB%80%E4%B9%88%E6%98%AFtree-shaking\" aria-label=\"什么是tree shaking permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>什么是Tree Shaking</h2>\n<p>在前端开发的过程中，一般整个代码会分散在项目的各个模块中，但是在最后在发送给客户端的时候，往往是一个大的bundle文件，各个模块的文件打包成一个JS文件，但是伴随而来的问题就是，某些永远跑不到的代码也会打到最后的bundle文件中，这就无形中增加了bundle的size。\n<code class=\"language-text\">Dead code elimination（简称DCE）</code>是一种可以消除最后编译产物中无用的代码的技术，就以上出现的问题DCE技术可以移除无用的不相关的代码，以达到减小产物size的作用。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> c <span class=\"token operator\">=</span> a <span class=\"token operator\">+</span> b<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> c<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> m <span class=\"token operator\">=</span> a <span class=\"token operator\">*</span> b<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// unreachable code</span>\n    <span class=\"token keyword\">return</span> m<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> c <span class=\"token operator\">=</span> a <span class=\"token operator\">*</span> b<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  <span class=\"token comment\">// unreachable code</span>\n        <span class=\"token comment\">// do something</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>以上的代码就是一个典型的可以通过<code class=\"language-text\">DCE</code>消除掉的例子，但是在前端<code class=\"language-text\">webpack</code>中可以消除掉这些永远跑不到的代码，但是存在一个问题就是如果你<code class=\"language-text\">import</code>了一个模块，这个模块暴露出了两个函数，你在运行时只使用了其中一个，那么在最后打包的时候另外一个函数也会被打进去，代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// helper.js</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// main.js</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>foo<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./helpers'</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>如上在这种情况下，我们只使用了<code class=\"language-text\">foo</code>函数，没有使用<code class=\"language-text\">bar</code>函数，最后使用<code class=\"language-text\">webpack</code>打包之后，我们不需要<code class=\"language-text\">bar</code>函数的代码，因为没人去调用它，但是<code class=\"language-text\">webpack</code>如果没有配置<code class=\"language-text\">tree shaking</code>的话，<code class=\"language-text\">bar</code>还是会被打进最后的<code class=\"language-text\">bundle</code>。\n<code class=\"language-text\">tree shaking</code>就是一种<code class=\"language-text\">DCE</code>技术，发源于<code class=\"language-text\">Lisp</code>，最早在JS中是在<code class=\"language-text\">google closure</code>中使用，后来<code class=\"language-text\">rollup</code>的作者在<code class=\"language-text\">rollup</code>中引入了<code class=\"language-text\">tree shaking</code>这个技术，同时在<code class=\"language-text\">webpack4</code>中也实现了相应的功能。</p>\n<h2 id=\"tree-shaking的限制\" style=\"position:relative;\"><a href=\"#tree-shaking%E7%9A%84%E9%99%90%E5%88%B6\" aria-label=\"tree shaking的限制 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tree Shaking的限制</h2>\n<p><code class=\"language-text\">Tree Shaking</code>的原理简单来说，就是程序的执行能够被一颗由函数调用组成的树表示，如果一个函数没有被调用到，那么这个函数就可以被消除掉；但是在<code class=\"language-text\">commonJS</code>中，<code class=\"language-text\">module</code>的加载不是静态的，这时候去做静态语法分析是比较困难的，但是<code class=\"language-text\">es6 moudle</code>的出现，使得这个问题变简单了，所以<code class=\"language-text\">tree shaking</code>的先决条件是你的<code class=\"language-text\">module</code>使用的是<code class=\"language-text\">es6</code>的<code class=\"language-text\">import/export</code>。</p>\n<h2 id=\"tree-shaking在webpack中的使用\" style=\"position:relative;\"><a href=\"#tree-shaking%E5%9C%A8webpack%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8\" aria-label=\"tree shaking在webpack中的使用 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tree Shaking在Webpack中的使用</h2>\n<p>配置<code class=\"language-text\">webpack babel loader</code>的插件：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"> <span class=\"token punctuation\">{</span>\n         loader<span class=\"token operator\">:</span> <span class=\"token string\">'babel-loader'</span><span class=\"token punctuation\">,</span>\n         test<span class=\"token operator\">:</span> dir_js<span class=\"token punctuation\">,</span>\n         query<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token comment\">// presets: ['es2015'],</span>\n\n        <span class=\"token comment\">// All of the plugins of babel-preset-es2015,</span>\n        <span class=\"token comment\">// minus babel-plugin-transform-es2015-modules-commonjs</span>\n        plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token comment\">// 'babel-plugin-transform-es2015-modules-commonjs',</span>\n          <span class=\"token string\">'transform-es2015-template-literals'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-literals'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-function-name'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-arrow-functions'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-block-scoped-functions'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-classes'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-object-super'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-shorthand-properties'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-computed-properties'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-for-of'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-sticky-regex'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-unicode-regex'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'check-es2015-constants'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-spread'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-parameters'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-destructuring'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-block-scoping'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'transform-es2015-typeof-symbol'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">[</span><span class=\"token string\">'transform-regenerator'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> async<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> asyncGenerators<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n   \t\t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span></code></pre></div>\n<p>如果要让<code class=\"language-text\">tree shaking</code>起作用，那么将es6插件中的<code class=\"language-text\">babel-plugin-transform-es2015-modules-commonjs</code>去掉，避免打成<code class=\"language-text\">commonJS</code>的包，不然<code class=\"language-text\">tree shaking</code>没用。</p>\n<p>如下我们有以下代码，我们使用<code class=\"language-text\">webpack</code>来编译它们，来看看使用<code class=\"language-text\">tree shaking</code>和不使用的区别：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">\t<span class=\"token comment\">// helper.js</span>\n\t<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'unreachable code'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// main.js</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>foo<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./helpers'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> elem <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'output'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'test'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>foo<span class=\"token punctuation\">)</span>\nelem<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Output: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>使用<code class=\"language-text\">webpack</code>编译后的部分代码：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 549px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.621621621621614%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABGUlEQVQoz5WSWY7CMBBEuf8ZZwMCSUy8xXa8p2gPAoGEBqYl/3ipftXljTEGzjlwwRF8RH/k4OMEyWfEXFBLQat1XX/Xq9o0wYUER8Yw6xnicw/x3YFtDzgNDD7Gm+A7tbHWwloDRoKtLOOQX0ewDxLcd3BS/J/QOQspJQrZCyEi+YRgA6L3iES/3gk+W/cOboTDOKK99Nph7miOOw7NTghavqS6J78JTtOEWgvYiRGtAp84zXAA6wdwTuLaIKeERHc93YlKUogepdZHwqtlISRtViiyfux7bHc/GAcBpS4NnVuQc0ZeFsRZI9MoUkwEUZ9YNpdQ2lnX9egPB5h5QX0v2EfL12/TLJdChEpDK4UYWvf1zzCehXIGBRS+WVHhyioAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tree shaking webpack0\"\n        title=\"tree shaking webpack0\"\n        src=\"/static/86bd028fa895e0175a630e158eb530d6/928ea/tree-shaking-webpack0.png\"\n        srcset=\"/static/86bd028fa895e0175a630e158eb530d6/12f09/tree-shaking-webpack0.png 148w,\n/static/86bd028fa895e0175a630e158eb530d6/e4a3f/tree-shaking-webpack0.png 295w,\n/static/86bd028fa895e0175a630e158eb530d6/928ea/tree-shaking-webpack0.png 549w\"\n        sizes=\"(max-width: 549px) 100vw, 549px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>如上图是在没有启用<code class=\"language-text\">tree-shaking</code>的时候打包之后的<code class=\"language-text\">bundle</code>，这里在最后的<code class=\"language-text\">bundle</code>文件中有没有使用的<code class=\"language-text\">bar</code>函数，下图是使用了<code class=\"language-text\">tree shaking</code>之后打包后的代码：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 380px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.054054054054056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAzElEQVQY04WP3Y7CIBBGff8H3OgmpkRKxUoLVH4sBT6hUbN7oT0JyVwMJ2d2jDFYZyH7AcdDh+b3hLHtwNgAqQyWkGCth3MOKSVUcs74xO585lBaYbwIiH2L8cghyuNMoBcK/DLgOk64GYMY47awFr64Tw63vkh+KHRbCnsJSQk0Pb13vslWYdOQdVhCgClnVYKdcTceaYmI3mHWGjnlt/BrIef8KVzQdVcQQjApCe9nxPT/41bdKqS0nFcKKikmhFJaa+v8qvlbtSV9AGmM1CMoykW1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tree shaking webpack1\"\n        title=\"tree shaking webpack1\"\n        src=\"/static/3c16a6a29d64fc4b34e873b704d99c2b/3f520/tree-shaking-webpack1.png\"\n        srcset=\"/static/3c16a6a29d64fc4b34e873b704d99c2b/12f09/tree-shaking-webpack1.png 148w,\n/static/3c16a6a29d64fc4b34e873b704d99c2b/e4a3f/tree-shaking-webpack1.png 295w,\n/static/3c16a6a29d64fc4b34e873b704d99c2b/3f520/tree-shaking-webpack1.png 380w\"\n        sizes=\"(max-width: 380px) 100vw, 380px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>可以看到在没有<code class=\"language-text\">tree shaking</code>的情况下没有使用的<code class=\"language-text\">bar</code>函数的代码也被打进了最后的<code class=\"language-text\">bundle</code>中，使用了<code class=\"language-text\">tree shaking</code>的将没有使用到的函数消除掉了。</p>\n</li>\n</ul>\n<h2 id=\"tree-shaking真的很美好吗？\" style=\"position:relative;\"><a href=\"#tree-shaking%E7%9C%9F%E7%9A%84%E5%BE%88%E7%BE%8E%E5%A5%BD%E5%90%97%EF%BC%9F\" aria-label=\"tree shaking真的很美好吗？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tree Shaking真的很美好吗？</h2>\n<p>  看到这里你可能觉得<code class=\"language-text\">tree shaking</code>真的很美好，能够帮你把一切在运行时没有使用到的代码消除掉，但是遗憾的是，在实际情况下并没有这么美好，看看下面的例子：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">\t<span class=\"token comment\">// helper.js</span>\n  <span class=\"token comment\">// top level function</span>\n  <span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  \t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      \tconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'unreachable code'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    \n  \t<span class=\"token punctuation\">}</span>\n  \t<span class=\"token keyword\">return</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  \t<span class=\"token keyword\">return</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n  <span class=\"token comment\">// top level object</span>\n\t<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> MyObject <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  \t<span class=\"token function-variable function\">fooFuncInObj</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      \t<span class=\"token keyword\">return</span> <span class=\"token string\">'foo in obj'</span><span class=\"token punctuation\">;</span>\n  \t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  \t<span class=\"token function-variable function\">barFuncInObj</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      \t<span class=\"token keyword\">return</span> <span class=\"token string\">'bar in obj'</span><span class=\"token punctuation\">;</span>\n  \t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\t\n  \n\t<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> MyObject1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  \t<span class=\"token function-variable function\">fooFuncInObj</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      \t<span class=\"token keyword\">return</span> <span class=\"token string\">'foo in obj'</span><span class=\"token punctuation\">;</span>\n  \t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  \t<span class=\"token function-variable function\">barFuncInObj</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      \t<span class=\"token keyword\">return</span> <span class=\"token string\">'bar in obj'</span><span class=\"token punctuation\">;</span>\n  \t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>    \n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\t\n  <span class=\"token comment\">// top level variable</span>\n\t<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> fooVar <span class=\"token operator\">=</span> <span class=\"token string\">\"I'm top level variable foo\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> barVar <span class=\"token operator\">=</span> <span class=\"token string\">\"I'm top level variable bar\"</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> varObj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  \tfoo<span class=\"token operator\">:</span> <span class=\"token string\">'variable foo in varObj'</span><span class=\"token punctuation\">,</span>\n      barVar<span class=\"token operator\">:</span> <span class=\"token string\">\"variable bar in varObj\"</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> foo<span class=\"token punctuation\">,</span> MyObject<span class=\"token punctuation\">,</span> fooVar<span class=\"token punctuation\">,</span> varObj <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./helpers'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> elem <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'output'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nelem<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Output0: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> \\n Output1: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>MyObject<span class=\"token punctuation\">.</span><span class=\"token function\">fooFuncInObj</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> \\n Output2: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>fooVar<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\\n Output1: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>varObj<span class=\"token punctuation\">.</span>foo<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>  如果<code class=\"language-text\">tree shaking</code>足够聪明，那么我们这里仅仅调用了<code class=\"language-text\">MyObject</code>下的一个函数，另外一个函数没有使用，同样的我们只使用了<code class=\"language-text\">varObj</code>下的一个变量，另外的变量不应该打到最后的<code class=\"language-text\">bundle</code>里面去，遗憾的是现实情况并不是这样，下图是<code class=\"language-text\">webpack</code>打出来的包：</p>\n<p>  <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 443px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 116.89189189189189%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAADDUlEQVQ4y51VyXKbQBTU/1eqcohzcDlH55Cc8h9J2RVrQxiDJBaxbwPDTucN8oIsyXEyVQNIJfW8ft39mERxhMgJEaj2sJ2NC9eN4AcxwoihKDjE6vt+2H9bk+GHbYsy5UiNAJ68Q2hHCLcaijB4BsMj4Bj41AGTrutQVhUY58jzDEVeoKlbgA5p6/oA5DXYWcCmamFvdrAsB0kQIGH8TVoD2DnKLQF2DVVT1AgITFpK0BQNq4UE9UEB80JEGwfR2oa3NqmvEUQRZym3RO1plVWJtumQeylyn6GmFnDHQZMxcNdBEfgHQGcBh+/pYpomDNOC63kwDB0720aZl2BuQgekSPwYcZK8v8I8z8ESBufBhK1aCAwD6XZLFQeI1TWSrY66bY5UH4MPotR1hbIs0TQN/meNK52IR5amkCQJtuPCItq6bmC72UDTtIG6rpvIeUV9tJGQUJlloCSPZlmGJ4bPFe572FN1NdYEcHt7i183N3S/gSzfY2f6iGP6o3CD8GZZoCXxOmIjGB1RHvdwralYrWRYmg51rsDXPZgURaH+W7E7oNy2L31LibpISrL1kWw8xKRsQQkS1fd99yhCN3o+3hPhgJq8xzJO4nT/Lshx9CKUmYWdugDnDkpmkIHVYZe+gsKTkdtLVPEaubUA294hd2VUlUd+DKmqwz3p6h/gyTWUxRXu5UvIiwusZhdY/P6Iu58foMw/Q11ekqm/gu+uEE4/EegXsOgaaXxNQ+Q7uvob+sdNPXyhKSwzn88xoz2dTaEbFhybYsibE0KAKuyPaD/bRiz14WGwiqXo2MxU+KSwtbXBi3wft4N0jO0yEmVsm6Igj9EszEV2nYRiWGB/YPdqHp5+HgDFhZM1PNcjleuBSv+OqJ2b3JOOPpTkPW9jIwzZMGCrnKOjKd5QKkQ6+q4dklHTGBNT/Bz4EWWRFImS4pM4bK0hWkwRSUtkpoFYXiJR7pFQtrnnkp3c4bCTrwDxZmMsG8ZXRBOZ0b2lCSQqKumtKAZtxdKhuobaI74rwpCG8T7LfffS4z/8XPNWuWpoJwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tree shaking webpack2\"\n        title=\"tree shaking webpack2\"\n        src=\"/static/f62125eb43456fc624e4d2f525a142c2/a120c/tree-shaking-webpack2.png\"\n        srcset=\"/static/f62125eb43456fc624e4d2f525a142c2/12f09/tree-shaking-webpack2.png 148w,\n/static/f62125eb43456fc624e4d2f525a142c2/e4a3f/tree-shaking-webpack2.png 295w,\n/static/f62125eb43456fc624e4d2f525a142c2/a120c/tree-shaking-webpack2.png 443w\"\n        sizes=\"(max-width: 443px) 100vw, 443px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>  从上面的代码我们可以有这样的结论，<code class=\"language-text\">webpack</code>的<code class=\"language-text\">tree shaking</code>对顶层函数、顶层变量和顶层对象有作用。</p>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<ul>\n<li><a href=\"https://en.wikipedia.org/wiki/Tree_shaking\">https://en.wikipedia.org/wiki/Tree_shaking</a></li>\n<li><a href=\"https://github.com/rauschma/tree-shaking-demo\">https://github.com/rauschma/tree-shaking-demo</a></li>\n<li><a href=\"http://2ality.com/2015/12/webpack-tree-shaking.html\">http://2ality.com/2015/12/webpack-tree-shaking.html</a></li>\n</ul>\n<hr>\n<p><strong><em>兴趣遍地都是，坚持和持之以恒才是稀缺的</em></strong></p>","frontmatter":{"title":"Tree Shaking","date":"December 22, 2018"}}},"pageContext":{"slug":"/2018-12-22-TreeShaking/","previous":{"fields":{"slug":"/2018-12-15-集成Sonarqube到项目/"},"frontmatter":{"title":"集成SonarQube到你的项目中","category":"Tech"}},"next":{"fields":{"slug":"/2018-12-29-Reselect/"},"frontmatter":{"title":"如何使用Reselect做性能优化","category":"Tech"}}}},"staticQueryHashes":["3128451518","96099027"]}